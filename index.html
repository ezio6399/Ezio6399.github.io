<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>PRO POS - Shift + DateTime Report + Details + Void Restock</title>

  <!-- Polyfillsï¼šæ•‘è€ PC / èˆŠ Safariï¼ˆé¿å…æ•´é  JS ç›´æ¥æ­»æ‰ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3.38.1/minified.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: -apple-system, system-ui, sans-serif; touch-action: manipulation; -webkit-overflow-scrolling: touch; overflow: hidden; background-color: #f8fafc; }
    .tab-content { display: none; height: calc(100vh - 64px); width: 100%; }
    .tab-content.active { display: flex; }

    /* Sidebarï¼šæ‰‹æ©Ÿ/å¹³æ¿æ»‘å‡ºï¼›PC å›ºå®šé¡¯ç¤º */
    #sidebar {
      position: fixed;
      top: 0; right: 0; bottom: 0;
      width: 380px;
      background: white;
      z-index: 220;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #e2e8f0;
      transition: transform 0.25s ease-in-out;
      box-shadow: -4px 0 15px rgba(0,0,0,0.05);
      flex-shrink: 0;
    }

    @media (min-width: 1024px) {
      #sidebar {
        position: relative;
        width: 380px !important;
        transform: translateX(0) !important;
        visibility: visible !important;
        flex-shrink: 0 !important;
      }
      #sidebarOverlay { display: none !important; }
    }

    @media (max-width: 1023px) {
      #sidebar { transform: translateX(100%); z-index: 220; }
      #sidebar.sidebar-active { transform: translateX(0); visibility: visible !important; }
    }

    #sidebarOverlay { z-index: 150; }

    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; color: black !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 52mm; margin: 0; padding: 0; }
      .print-page { width: 100%; font-family: monospace; font-size: 12pt; line-height: 1.2; page-break-after: always; padding: 2mm; }
      .print-page h1 { font-size: 24pt !important; font-weight: 900 !important; margin: 2mm 0; }
      .print-page h2 { font-size: 16pt !important; font-weight: bold !important; }
      hr { border: none; border-top: 1px dashed black !important; margin: 2mm 0; }
    }
  </style>
</head>

<body class="h-screen flex flex-col">

<header class="bg-slate-900 text-white h-16 flex items-center justify-between px-6 flex-shrink-0 z-[250] no-print">
  <div class="flex items-center space-x-6">
    <span id="displayStoreName" class="text-xl font-black bg-blue-600 px-3 py-1 rounded tracking-tighter">PRO POS</span>
    <nav class="flex space-x-2 font-bold text-sm">
      <button data-tab="orderTab" class="px-4 py-2 rounded-xl hover:bg-slate-800 transition">é»é¤</button>
      <button data-tab="kdsTab" class="px-4 py-2 rounded-xl hover:bg-slate-800 text-orange-400">å»šæˆ¿</button>
      <button data-tab="reportTab" class="px-4 py-2 rounded-xl hover:bg-slate-800 text-slate-400">å ±è¡¨</button>
      <button data-tab="adminTab" class="px-4 py-2 rounded-xl hover:bg-slate-800 text-slate-400">è¨­å®š</button>
    </nav>
  </div>

  <div class="flex items-center gap-4">
    <div id="shiftBadge" class="hidden md:flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-xl text-xs font-black">
      <span class="text-slate-400">ç­åˆ¥</span>
      <span id="shiftStatusText" class="text-emerald-400">æœªé–‹ç­</span>
    </div>
    <div id="digitalClock" class="font-mono text-slate-400 tracking-widest hidden md:block">00:00:00</div>
  </div>
</header>

<main class="flex-1 flex overflow-hidden relative">
  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 hidden" onclick="sidebarToggle(false)"></div>

  <!-- é»é¤ -->
  <div id="orderTab" class="tab-content active w-full">
    <div class="flex-1 p-6 overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-slate-700">
          <span class="text-slate-400 text-xs uppercase tracking-widest">Shift</span>
          <div class="text-lg">
            <span id="shiftLineText">æœªé–‹ç­ï¼ˆè«‹åˆ°ã€Œå ±è¡¨ã€æˆ–ã€Œè¨­å®šã€é–‹ç­ï¼‰</span>
          </div>
        </div>
        <div class="hidden sm:flex items-center gap-2">
          <button id="openShiftMiniBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-black active:bg-emerald-700">é–‹ç­</button>
          <button id="closeShiftMiniBtn" class="px-4 py-2 rounded-xl bg-rose-600 text-white font-black active:bg-rose-700">é—œç­</button>
        </div>
      </div>

      <div id="menuDisplay" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-4"></div>
      <div class="h-32"></div>
    </div>

    <div id="sidebar" class="flex-shrink-0">
      <div class="p-6 bg-slate-50 border-b flex justify-between items-center">
        <div class="flex flex-col">
          <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Queue No.</span>
          <span class="text-3xl font-black text-blue-600 italic">#<span id="nextQueueNo">---</span></span>
          <span class="text-xs font-black text-slate-400 mt-1">ä»¥ã€Œé–‹ç­ã€ç‚ºèµ·é»</span>
        </div>
        <button id="closeSidebarBtn" class="lg:hidden w-12 h-12 bg-white rounded-full shadow-sm border flex items-center justify-center font-bold text-slate-500 text-2xl">âœ•</button>
      </div>

      <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>

      <div class="p-6 bg-slate-50 border-t space-y-4 pb-12">
        <div class="flex justify-between items-center text-3xl font-black text-slate-800">
          <span class="text-base text-slate-400 uppercase font-bold tracking-wider">Total</span>
          <span>$<span id="totalPrice">0</span></span>
        </div>

        <button id="checkoutBtn" class="w-full bg-blue-600 text-white py-6 rounded-2xl text-2xl font-black shadow-lg shadow-blue-200 active:bg-blue-800 transition-all">
          ç¢ºèªçµå¸³
        </button>

        <div class="text-xs text-slate-400 font-bold">
          åˆ—å°ï¼š<span class="text-emerald-600">é›²ç«¯åˆ—å°ï¼ˆPrint Agentï¼‰</span>
        </div>
      </div>
    </div>

    <button id="openSidebarBtn" class="lg:hidden fixed bottom-8 right-8 bg-blue-600 text-white w-20 h-20 rounded-full shadow-2xl flex items-center justify-center z-[120] active:scale-95 transition-transform">
      <span class="text-3xl">ğŸ›’</span>
      <span id="mobileCartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-sm w-8 h-8 rounded-full flex items-center justify-center border-4 border-white font-black">0</span>
    </button>
  </div>

  <!-- å»šæˆ¿ -->
  <div id="kdsTab" class="tab-content bg-slate-800 p-6 overflow-x-auto">
    <div id="kdsContainer" class="flex space-x-6 h-full items-start"></div>
  </div>

  <!-- å ±è¡¨ -->
  <div id="reportTab" class="tab-content bg-slate-100 p-8 overflow-y-auto flex-col">
    <div class="max-w-6xl mx-auto w-full space-y-6">

      <!-- ç­åˆ¥æ§åˆ¶ + ç¯©é¸ -->
      <div class="bg-white rounded-3xl border shadow-sm p-6 space-y-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div class="font-black text-slate-800">
            <div class="text-xs text-slate-400 uppercase tracking-widest">çµç®—æ–¹å¼</div>
            <div class="text-xl">ä»¥ã€Œé–‹ç­ã€é–‹å§‹è¨ˆç®—ï¼Œã€Œé—œç­ã€åšçµå¸³</div>
            <div class="text-sm text-slate-400 font-bold mt-1">ç­åˆ¥ç‹€æ…‹ï¼š<span id="reportShiftStatus" class="text-emerald-600">æœªé–‹ç­</span></div>
          </div>

          <div class="flex gap-2">
            <button id="openShiftBtn" class="px-5 py-3 rounded-2xl bg-emerald-600 text-white font-black active:bg-emerald-700">é–‹ç­</button>
            <button id="closeShiftBtn" class="px-5 py-3 rounded-2xl bg-rose-600 text-white font-black active:bg-rose-700">é—œç­</button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
          <div class="space-y-1">
            <div class="text-xs font-black text-slate-400 uppercase">ç­åˆ¥</div>
            <select id="shiftSelect" class="w-full p-3 rounded-2xl border font-black"></select>
          </div>

          <div class="space-y-1">
            <div class="text-xs font-black text-slate-400 uppercase">é–‹å§‹æ™‚é–“</div>
            <input id="dtStart" type="datetime-local" class="w-full p-3 rounded-2xl border font-black">
          </div>

          <div class="space-y-1">
            <div class="text-xs font-black text-slate-400 uppercase">çµæŸæ™‚é–“</div>
            <input id="dtEnd" type="datetime-local" class="w-full p-3 rounded-2xl border font-black">
          </div>

          <div class="flex items-end gap-2">
            <button id="applyReportFilterBtn" class="flex-1 py-3 rounded-2xl bg-slate-900 text-white font-black active:scale-95">å¥—ç”¨ç¯©é¸</button>
            <button id="resetReportFilterBtn" class="flex-1 py-3 rounded-2xl bg-white border font-black text-slate-700 active:bg-slate-50">é‡ç½®</button>
          </div>
        </div>
      </div>

      <!-- KPI + åŒ¯å‡º -->
      <div class="grid grid-cols-3 gap-6 font-black text-center">
        <div class="bg-white p-6 rounded-3xl border shadow-sm">
          <p class="text-xs text-slate-400 uppercase">ç¯©é¸ç‡Ÿæ”¶</p>
          <p id="totalRevenue" class="text-blue-600 text-2xl">$0</p>
        </div>
        <div class="bg-white p-6 rounded-3xl border shadow-sm">
          <p class="text-xs text-slate-400 uppercase">å–®æ•¸</p>
          <p id="totalOrders" class="text-2xl text-slate-800">0</p>
        </div>
        <button id="exportExcelBtn" class="bg-emerald-600 text-white rounded-3xl text-xl shadow-lg active:bg-emerald-700">åŒ¯å‡º Excel</button>
      </div>

      <!-- è¡¨æ ¼ -->
      <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
        <table class="w-full text-left font-bold border-collapse">
          <thead class="bg-slate-50 border-b text-slate-400 text-xs uppercase">
            <tr class="divide-x">
              <th class="p-4">æ™‚é–“</th>
              <th class="p-4 text-center">å–å–®è™Ÿ / æ˜ç´°</th>
              <th class="p-4 text-right">é‡‘é¡</th>
              <th class="p-4 text-center">ç‹€æ…‹</th>
              <th class="p-4 text-center">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="reportTableBody" class="divide-y text-sm"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- è¨­å®š -->
  <div id="adminTab" class="tab-content bg-white p-8 overflow-y-auto flex-col">
    <div class="max-w-xl mx-auto w-full space-y-10">

      <section class="bg-slate-50 p-6 rounded-3xl border space-y-4">
        <h2 class="text-2xl font-black text-blue-600 border-l-8 border-blue-600 pl-4">å“ç‰Œèˆ‡åˆ—å°è¨­å®š</h2>
        <input type="text" id="cfgStoreId" placeholder="Store IDï¼ˆä¾‹ï¼šnantun01ï¼‰" class="w-full p-4 rounded-2xl border font-bold">
        <input type="text" id="cfgStoreName" placeholder="è‡ªå®šç¾©åº—å" class="w-full p-4 rounded-2xl border font-bold">
        <input type="text" id="cfgPhone" placeholder="æ”¶æ“šè¯çµ¡é›»è©±" class="w-full p-4 rounded-2xl border font-bold">
        <input type="text" id="cfgNote" placeholder="æ”¶æ“šåº•éƒ¨è¨Šæ¯" class="w-full p-4 rounded-2xl border font-bold">

        <div class="flex gap-2">
          <button id="saveSettingsBtn" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-black active:scale-95 transition">å„²å­˜é›²ç«¯è¨­å®š</button>
          <button id="openShiftAdminBtn" class="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-black active:scale-95 transition">é–‹ç­</button>
          <button id="closeShiftAdminBtn" class="flex-1 bg-rose-600 text-white py-4 rounded-2xl font-black active:scale-95 transition">é—œç­</button>
        </div>

        <div class="text-xs text-slate-400 font-bold">
          Print Agent è¦ç›£è½åŒä¸€å€‹ Store ID æ‰æœƒå°ã€‚<br>
          ç­åˆ¥ï¼šæœªé–‹ç­æ™‚ç¦æ­¢çµå¸³ï¼ˆé¿å…å¸³å‹™äº‚æ‰ï¼‰ã€‚
        </div>
      </section>

      <section class="bg-slate-50 p-6 rounded-3xl border space-y-4">
        <h2 class="text-2xl font-black text-green-600 border-l-8 border-green-600 pl-4">é¤é»åº«å­˜ç®¡ç†</h2>
        <div class="flex flex-col sm:flex-row gap-2">
          <input type="text" id="newProdName" placeholder="é¤é»å“å" class="flex-1 p-3 border rounded-xl font-bold">
          <input type="number" id="newProdPrice" placeholder="åƒ¹æ ¼" class="w-full sm:w-24 p-3 border rounded-xl font-bold text-center">
          <input type="number" id="newProdStock" placeholder="åº«å­˜" class="w-full sm:w-24 p-3 border rounded-xl font-bold text-center">
        </div>
        <button id="addProductBtn" class="w-full bg-blue-600 text-white py-3 rounded-2xl font-black active:scale-95 transition">æ–°å¢ç”¢å“</button>
        <div id="menuListUI" class="space-y-2 mt-4"></div>
      </section>

    </div>
  </div>
</main>

<div id="printArea"></div>

<div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-2xl font-black shadow-2xl hidden z-[9999]"></div>

<script>
  /* -----------------------------
     Utilities (ES5-safe)
  ----------------------------- */
  function padLeft(num, len) { var s = String(num); while (s.length < len) s = '0' + s; return s; }
  function safeText(el, text) { if (!el) return; el.textContent = String(text !== undefined && text !== null ? text : ''); }
  function escapeHTML(str) {
    str = String(str !== undefined && str !== null ? str : '');
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }
  function fmtMoney(n) { n = Number(n || 0); try { return n.toLocaleString(); } catch(e) { return String(n); } }
  function showToast(msg) {
    var t = document.getElementById('toast');
    if (!t) return;
    t.textContent = msg;
    t.classList.remove('hidden');
    setTimeout(function(){ t.classList.add('hidden'); }, 1800);
  }
  function sidebarToggle(open) {
    var sb = document.getElementById('sidebar');
    var ov = document.getElementById('sidebarOverlay');
    if (open) { sb.classList.add('sidebar-active'); ov.classList.remove('hidden'); }
    else { sb.classList.remove('sidebar-active'); ov.classList.add('hidden'); }
  }
  function changeTab(id) {
    var tabs = document.querySelectorAll('.tab-content');
    for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
    document.getElementById(id).classList.add('active');
    if (id === 'reportTab') renderReportUI();
    sidebarToggle(false);
  }
  function snapToArrayWithKey(snap) {
    var out = [];
    snap.forEach(function(child){ var v = child.val() || {}; v.__key = child.key; out.push(v); });
    return out;
  }

  function toLocalInputValue(dateObj) {
    // datetime-local éœ€è¦ YYYY-MM-DDTHH:mm
    var d = dateObj;
    var yyyy = d.getFullYear();
    var mm = padLeft(d.getMonth()+1,2);
    var dd = padLeft(d.getDate(),2);
    var hh = padLeft(d.getHours(),2);
    var mi = padLeft(d.getMinutes(),2);
    return yyyy + '-' + mm + '-' + dd + 'T' + hh + ':' + mi;
  }
  function parseLocalInputValue(v) {
    // v: YYYY-MM-DDTHH:mm
    if (!v) return null;
    var d = new Date(v);
    if (isNaN(d.getTime())) return null;
    return d;
  }

  function summarizeItems(items) {
    // å›å‚³ "çƒ¤é­šx2, ç™½é£¯x1"
    if (!items || !items.length) return '';
    var map = {};
    for (var i=0;i<items.length;i++){
      var n = items[i].name || '';
      if (!n) continue;
      map[n] = (map[n] || 0) + 1;
    }
    var parts = [];
    for (var k in map) if (map.hasOwnProperty(k)) parts.push(k + 'x' + map[k]);
    return parts.join(', ');
  }

  /* -----------------------------
     Firebase init
  ----------------------------- */
  var firebaseConfig = {
    apiKey: "AIzaSyB4V2Zfzl_22tka2QHfkNSGaa23ke2TeWk",
    authDomain: "flash-e1c46.firebaseapp.com",
    projectId: "flash-e1c46",
    storageBucket: "flash-e1c46.firebasestorage.app",
    messagingSenderId: "927841326710",
    appId: "1:927841326710:web:d832accdbf2a323ad1b157",
    measurementId: "G-BVT622JRJT",
    databaseURL: "https://flash-e1c46-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  var db = firebase.database();

  /* -----------------------------
     State
  ----------------------------- */
  var settings = { storeId: 'default', storeName: 'å—å±¯ä»»çƒ¤é­š', phone: '02-1234', note: 'è¬è¬æƒ é¡§' };
  var menu = [];
  var sales = [];
  var kdsOrders = [];
  var cart = [];
  var busyCheckout = false;

  // Shift
  var currentShiftId = null;
  var shifts = []; // [{__key, openedAt, closedAt, status}]
  var reportFilter = {
    shiftId: '', // '' = all
    start: null,
    end: null
  };

  /* -----------------------------
     Cloud print queue
  ----------------------------- */
  function enqueuePrintJob(payload) {
    payload = payload || {};
    var storeId = (settings && settings.storeId) ? settings.storeId : 'default';
    var ref = db.ref('printJobs/' + storeId).push();
    return ref.set({
      status: 'NEW',
      createdAt: new Date().toISOString(),
      type: payload.type || 'receipt',
      html: payload.html || '',
      meta: payload.meta || {}
    }).then(function(){ return ref.key; });
  }

  /* -----------------------------
     Shift logic
  ----------------------------- */
  function setShiftUI() {
    var badge = document.getElementById('shiftBadge');
    if (badge) badge.classList.remove('hidden');

    var statusText = currentShiftId ? ('é–‹ç­ä¸­ #' + currentShiftId.slice(-6)) : 'æœªé–‹ç­';
    safeText(document.getElementById('shiftStatusText'), statusText);
    safeText(document.getElementById('shiftLineText'), currentShiftId ? ('é–‹ç­ä¸­ï¼ˆç­åˆ¥ #' + currentShiftId.slice(-6) + 'ï¼‰') : 'æœªé–‹ç­ï¼ˆè«‹åˆ°ã€Œå ±è¡¨ã€æˆ–ã€Œè¨­å®šã€é–‹ç­ï¼‰');
    safeText(document.getElementById('reportShiftStatus'), currentShiftId ? ('é–‹ç­ä¸­ #' + currentShiftId.slice(-6)) : 'æœªé–‹ç­');

    // æœªé–‹ç­æ™‚ queue é è¦½é¡¯ç¤º ---
    if (!currentShiftId) safeText(document.getElementById('nextQueueNo'), '---');
  }

  function openShift() {
    if (currentShiftId) { showToast('å·²é–‹ç­ï¼Œä¸è¦é‡è¤‡é–‹'); return; }
    var now = new Date().toISOString();
    var ref = db.ref('shifts').push();
    var shiftId = ref.key;

    // å»ºç«‹ shift + è¨­å®šç›®å‰ç­åˆ¥ + åˆå§‹åŒ– counter
    return ref.set({ openedAt: now, closedAt: '', status: 'OPEN' })
      .then(function(){
        return db.ref('runtime/currentShiftId').set(shiftId);
      })
      .then(function(){
        return db.ref('shiftCounters/' + shiftId + '/queue').set(0);
      })
      .then(function(){
        showToast('é–‹ç­å®Œæˆ');
      })
      .catch(function(err){
        showToast('é–‹ç­å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
      });
  }

  function closeShift() {
    if (!currentShiftId) { showToast('ç›®å‰æœªé–‹ç­'); return; }
    var now = new Date().toISOString();
    var sid = currentShiftId;

    // é—œç­ï¼šæ›´æ–° shift + æ¸…ç©º currentShiftId
    return db.ref('shifts/' + sid).update({ closedAt: now, status: 'CLOSED' })
      .then(function(){
        return db.ref('runtime/currentShiftId').set(null);
      })
      .then(function(){
        showToast('é—œç­å®Œæˆ');
      })
      .catch(function(err){
        showToast('é—œç­å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
      });
  }

  /* -----------------------------
     Queue number transaction by shift
  ----------------------------- */
  var queueCounterUnsubRef = null;
  function listenShiftQueuePreview(shiftId) {
    // ç§»é™¤èˆŠ listener
    if (queueCounterUnsubRef) {
      queueCounterUnsubRef.off();
      queueCounterUnsubRef = null;
    }
    if (!shiftId) { safeText(document.getElementById('nextQueueNo'), '---'); return; }

    var ref = db.ref('shiftCounters/' + shiftId + '/queue');
    queueCounterUnsubRef = ref;
    ref.on('value', function(snap){
      var cur = Number(snap.val() || 0);
      safeText(document.getElementById('nextQueueNo'), padLeft(cur + 1, 3));
    });
  }

  function nextQueueNoTx(shiftId) {
    var ref = db.ref('shiftCounters/' + shiftId + '/queue');
    return ref.transaction(function(cur){ return (cur || 0) + 1; })
      .then(function(res){
        if (!res.committed) throw new Error('Queue transaction failed');
        return padLeft(res.snapshot.val(), 3);
      });
  }

  function decStockTx(menuId, qty) {
    qty = qty || 1;
    var ref = db.ref('menu/' + menuId + '/stock');
    return ref.transaction(function(cur){
      if (cur === null) return;
      if (cur < qty) return;
      return cur - qty;
    }).then(function(res){ return !!res.committed; });
  }

  function incStockTx(menuId, qty) {
    qty = qty || 1;
    var ref = db.ref('menu/' + menuId + '/stock');
    return ref.transaction(function(cur){
      if (cur === null) return (0 + qty);
      return cur + qty;
    }).then(function(res){ return !!res.committed; });
  }

  /* -----------------------------
     Render UI
  ----------------------------- */
  function renderMenu() {
    var wrap = document.getElementById('menuDisplay');
    var html = '';
    for (var i = 0; i < menu.length; i++) {
      var p = menu[i];
      var disabled = (Number(p.stock) <= 0);
      html += ''
        + '<div class="' + (disabled ? 'bg-slate-200 opacity-60 cursor-not-allowed' : 'bg-white active:bg-blue-50 cursor-pointer')
        + ' p-6 rounded-[2rem] border shadow-sm h-40 flex flex-col justify-between relative active:scale-95 transition-all"'
        + ' data-id="' + escapeHTML(p.id) + '">'
        +   '<span class="name font-black text-slate-800 text-xl leading-tight"></span>'
        +   '<div class="flex justify-between items-end">'
        +     '<span class="text-blue-600 font-black text-2xl">$' + escapeHTML(p.price) + '</span>'
        +     '<span class="text-xs font-bold text-slate-400">STOCK: ' + escapeHTML(p.stock) + '</span>'
        +   '</div>'
        +   (disabled ? '<span class="absolute inset-0 flex items-center justify-center font-black text-red-500 rotate-12 text-2xl">SOLD OUT</span>' : '')
        + '</div>';
    }
    wrap.innerHTML = html;

    var cards = wrap.children;
    for (var j = 0; j < cards.length; j++) {
      (function(idx){
        var card = cards[idx];
        var p2 = menu[idx];
        card.querySelector('.name').textContent = p2.name;
        if (Number(p2.stock) > 0) {
          card.addEventListener('click', function(){ addItemToCart(p2.id); });
        }
      })(j);
    }
  }

  function addItemToCart(menuId) {
    var m = null;
    for (var i = 0; i < menu.length; i++) if (menu[i].id === menuId) { m = menu[i]; break; }
    if (!m || Number(m.stock) <= 0) return;
    cart.push({ menuId: m.id, name: m.name, price: Number(m.price) });
    renderCartUI();
    if (window.innerWidth < 1024) sidebarToggle(true);
  }

  function renderCartUI() {
    document.getElementById('mobileCartCount').innerText = String(cart.length);
    var container = document.getElementById('cartItems');

    if (cart.length === 0) {
      container.innerHTML = '<div class="h-full flex items-center justify-center text-slate-300 italic py-20">ç­‰å¾…é»é¤...</div>';
      document.getElementById('totalPrice').innerText = '0';
      return;
    }

    var html = '';
    for (var i = 0; i < cart.length; i++) {
      html += ''
        + '<div class="flex justify-between items-center bg-slate-50 p-5 rounded-2xl border text-lg font-bold">'
        +   '<span class="item-name"></span>'
        +   '<div class="flex items-center space-x-4">'
        +     '<span>$' + escapeHTML(cart[i].price) + '</span>'
        +     '<button class="remove-btn w-10 h-10 bg-white text-red-500 rounded-full shadow-sm flex items-center justify-center text-xl font-black" data-idx="' + i + '">âœ•</button>'
        +   '</div>'
        + '</div>';
    }
    container.innerHTML = html;

    var rows = container.children;
    for (var r = 0; r < rows.length; r++) rows[r].querySelector('.item-name').textContent = cart[r].name;

    var btns = container.querySelectorAll('.remove-btn');
    for (var b = 0; b < btns.length; b++) {
      btns[b].addEventListener('click', function(e){
        e.stopPropagation();
        var idx = Number(this.getAttribute('data-idx'));
        cart.splice(idx, 1);
        renderCartUI();
      });
    }

    var total = 0;
    for (var t = 0; t < cart.length; t++) total += Number(cart[t].price || 0);
    document.getElementById('totalPrice').innerText = fmtMoney(total);
  }

  function renderKDSUI() {
    var wrap = document.getElementById('kdsContainer');
    var html = '';
    for (var i = 0; i < kdsOrders.length; i++) {
      var o = kdsOrders[i];
      var itemsHtml = '';
      if (o.items && o.items.length) {
        for (var k = 0; k < o.items.length; k++) {
          itemsHtml += '<div class="border-b pb-2">â–¡ ' + escapeHTML(o.items[k].name) + '</div>';
        }
      }
      html += ''
        + '<div class="w-80 bg-white rounded-[2.5rem] shadow-2xl flex-shrink-0 flex flex-col border-4 border-blue-500 overflow-hidden h-fit">'
        +   '<div class="bg-blue-600 text-white p-5 flex justify-between items-center">'
        +     '<span class="text-4xl font-black">#' + escapeHTML(o.queueNo) + '</span>'
        +     '<span class="font-mono text-xl timer" data-start="' + escapeHTML(o.time) + '">00:00</span>'
        +   '</div>'
        +   '<div class="p-6 space-y-3 font-black text-2xl text-slate-700">' + itemsHtml + '</div>'
        +   '<button class="done-btn bg-emerald-500 text-white py-8 text-3xl font-black active:bg-emerald-700 transition" data-kdskey="' + escapeHTML(o.__key) + '">å®Œæˆ</button>'
        + '</div>';
    }
    wrap.innerHTML = html;

    var doneBtns = wrap.querySelectorAll('.done-btn');
    for (var j = 0; j < doneBtns.length; j++) {
      doneBtns[j].addEventListener('click', function(){
        var key = this.getAttribute('data-kdskey');
        if (!key) return;
        db.ref('kds').child(key).remove();
      });
    }
  }

  function renderShiftSelect() {
    var sel = document.getElementById('shiftSelect');
    if (!sel) return;

    var html = '<option value="">å…¨éƒ¨ç­åˆ¥</option>';
    // æ–°çš„åœ¨ä¸Š
    for (var i = shifts.length - 1; i >= 0; i--) {
      var s = shifts[i];
      var label = '';
      var openT = s.openedAt ? new Date(s.openedAt) : null;
      var closeT = s.closedAt ? new Date(s.closedAt) : null;

      var openText = openT && !isNaN(openT.getTime()) ? openT.toLocaleString() : 'æœªçŸ¥æ™‚é–“';
      var closeText = (closeT && !isNaN(closeT.getTime())) ? closeT.toLocaleString() : (s.status === 'OPEN' ? 'é–‹ç­ä¸­' : '');

      label = '#' + String(s.__key).slice(-6) + ' | ' + openText + (closeText ? (' â†’ ' + closeText) : '');
      html += '<option value="' + escapeHTML(s.__key) + '">' + escapeHTML(label) + '</option>';
    }
    sel.innerHTML = html;

    // å„ªå…ˆé¸ï¼šç›®å‰ç­åˆ¥ï¼Œå¦å‰‡ç¶­æŒåŸ filter
    if (currentShiftId) sel.value = currentShiftId;
    else if (reportFilter.shiftId) sel.value = reportFilter.shiftId;
    else sel.value = '';
  }

  function getFilteredSales() {
    var out = [];
    var shiftId = reportFilter.shiftId || '';
    var start = reportFilter.start;
    var end = reportFilter.end;

    for (var i = 0; i < sales.length; i++) {
      var s = sales[i] || {};
      if ((s.status || 'OK') === 'VOID') continue;

      if (shiftId && s.shiftId !== shiftId) continue;

      var dt = new Date(s.date);
      if (isNaN(dt.getTime())) continue;

      if (start && dt < start) continue;
      if (end && dt > end) continue;

      out.push(s);
    }
    out.sort(function(a,b){ return new Date(b.date) - new Date(a.date); });
    return out;
  }

  function renderReportUI() {
    var filtered = getFilteredSales();

    var revenue = 0;
    for (var r = 0; r < filtered.length; r++) revenue += Number(filtered[r].total || 0);

    document.getElementById('totalRevenue').innerText = '$' + fmtMoney(revenue);
    document.getElementById('totalOrders').innerText = String(filtered.length);

    var body = document.getElementById('reportTableBody');
    var html = '';
    for (var j = 0; j < filtered.length; j++) {
      var s = filtered[j];
      var timeText = '';
      try { timeText = new Date(s.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
      catch(e) { timeText = new Date(s.date).toLocaleTimeString(); }

      var detail = summarizeItems(s.items || []);

      html += ''
        + '<tr>'
        +   '<td class="p-6 text-blue-600 font-black">' + escapeHTML(timeText) + '</td>'
        +   '<td class="p-6 text-center">'
        +     '<div class="text-2xl font-black">#' + escapeHTML(s.queueNo || '---') + '</div>'
        +     '<div class="text-xs text-slate-400 font-black mt-1 break-words">' + escapeHTML(detail || 'ï¼ˆç„¡æ˜ç´°ï¼‰') + '</div>'
        +   '</td>'
        +   '<td class="p-6 text-right font-black text-2xl">$' + fmtMoney(s.total) + '</td>'
        +   '<td class="p-6 text-center">'
        +     '<span class="px-3 py-1 rounded-xl text-xs font-black ' + ((s.status||'OK')==='OK' ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700') + '">'
        +       escapeHTML((s.status||'OK')==='OK' ? 'æ­£å¸¸' : 'ä½œå»¢')
        +     '</span>'
        +   '</td>'
        +   '<td class="p-6 text-center">'
        +     '<button class="void-btn text-red-500 font-black border-2 border-red-50 px-4 py-1 rounded-xl active:bg-red-50 transition" data-key="' + escapeHTML(s.__key) + '">ä½œå»¢</button>'
        +   '</td>'
        + '</tr>';
    }
    body.innerHTML = html;

    var voidBtns = body.querySelectorAll('.void-btn');
    for (var vb = 0; vb < voidBtns.length; vb++) {
      voidBtns[vb].addEventListener('click', function(){
        var key = this.getAttribute('data-key');
        voidOrderByKey(key);
      });
    }
  }

  function refreshKDSTimers() {
    var els = document.querySelectorAll('.timer');
    for (var i = 0; i < els.length; i++) {
      var start = new Date(els[i].getAttribute('data-start'));
      if (isNaN(start.getTime())) continue;
      var diff = Math.floor((new Date() - start) / 1000);
      var m = Math.floor(diff / 60);
      var s = diff % 60;
      els[i].textContent = padLeft(m, 2) + ':' + padLeft(s, 2);
    }
  }

  /* -----------------------------
     Admin actions
  ----------------------------- */
  function saveSettings() {
    var storeId = (document.getElementById('cfgStoreId').value || '').trim() || 'default';
    var storeName = (document.getElementById('cfgStoreName').value || '').trim() || 'PRO POS';
    var phone = (document.getElementById('cfgPhone').value || '').trim();
    var note = (document.getElementById('cfgNote').value || '').trim();

    db.ref('settings').set({ storeId: storeId, storeName: storeName, phone: phone, note: note })
      .then(function(){ showToast('è¨­å®šå·²åŒæ­¥'); })
      .catch(function(err){ showToast('å„²å­˜å¤±æ•—ï¼š' + (err && err.message ? err.message : err)); });
  }

  function addProduct() {
    var name = (document.getElementById('newProdName').value || '').trim();
    var price = Number(document.getElementById('newProdPrice').value);
    var stock = Number(document.getElementById('newProdStock').value);
    if (!isFinite(stock)) stock = 0;
    if (!name || !isFinite(price) || price <= 0) return;

    var ref = db.ref('menu').push();
    ref.set({ id: ref.key, name: name, price: price, stock: Math.floor(stock) })
      .then(function(){
        document.getElementById('newProdName').value = '';
        document.getElementById('newProdPrice').value = '';
        document.getElementById('newProdStock').value = '';
        showToast('æ–°å¢å®Œæˆ');
      })
      .catch(function(err){ showToast('æ–°å¢å¤±æ•—ï¼š' + (err && err.message ? err.message : err)); });
  }

  function renderAdminUI() {
    var wrap = document.getElementById('menuListUI');
    var html = '';
    for (var i = 0; i < menu.length; i++) {
      var p = menu[i];
      html += ''
        + '<div class="flex justify-between items-center bg-white p-6 rounded-3xl border shadow-sm">'
        +   '<div class="flex flex-col">'
        +     '<span class="name font-black text-slate-700 text-xl font-sans"></span>'
        +     '<span class="text-blue-600 font-black">$' + escapeHTML(p.price) + '</span>'
        +   '</div>'
        +   '<div class="flex items-center space-x-4">'
        +     '<input type="number" value="' + escapeHTML(p.stock) + '" class="stock-input w-20 p-2 border-2 rounded-xl text-center font-black text-xl" data-id="' + escapeHTML(p.id) + '">'
        +     '<button class="delete-btn text-red-500 font-black px-4 text-2xl" data-id="' + escapeHTML(p.id) + '">âœ•</button>'
        +   '</div>'
        + '</div>';
    }
    wrap.innerHTML = html;

    var rows = wrap.children;
    for (var r = 0; r < rows.length; r++) rows[r].querySelector('.name').textContent = menu[r].name;

    var stockInputs = wrap.querySelectorAll('.stock-input');
    for (var s = 0; s < stockInputs.length; s++) {
      stockInputs[s].addEventListener('change', function(){
        var id = this.getAttribute('data-id');
        var val = Number(this.value);
        if (!id || !isFinite(val) || val < 0) return;
        db.ref('menu').child(id).update({ stock: Math.floor(val) });
      });
    }

    var delBtns = wrap.querySelectorAll('.delete-btn');
    for (var d = 0; d < delBtns.length; d++) {
      delBtns[d].addEventListener('click', function(){
        var id = this.getAttribute('data-id');
        if (!id) return;
        if (!confirm('åˆªé™¤ï¼Ÿ')) return;
        db.ref('menu').child(id).remove();
      });
    }
  }

  function exportToExcel() {
    var filtered = getFilteredSales();
    var rows = [];
    for (var i = 0; i < filtered.length; i++) {
      var s = filtered[i];
      rows.push({
        'æ™‚é–“': s.date,
        'ç­åˆ¥': s.shiftId ? String(s.shiftId).slice(-6) : '',
        'å–å–®è™Ÿ': s.queueNo,
        'å–®è™Ÿ': s.orderId,
        'ç¸½é¡': s.total,
        'æ˜ç´°': summarizeItems(s.items || []),
        'ç‹€æ…‹': (s.status || 'OK')
      });
    }
    var ws = XLSX.utils.json_to_sheet(rows);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sales");
    XLSX.writeFile(wb, (settings.storeName || 'POS') + "_å ±è¡¨.xlsx");
  }

  /* -----------------------------
     Void order: mark VOID + restock + remove KDS
  ----------------------------- */
  function voidOrderByKey(salesKey) {
    if (!salesKey) return;
    if (!confirm('ç¢ºèªä½œå»¢æ­¤è¨‚å–®ï¼Ÿåº«å­˜å°‡å›è£œï¼Œå ±è¡¨ä¿ç•™ä½œå»¢ç´€éŒ„ã€‚')) return;

    var ref = db.ref('sales/' + salesKey);
    ref.once('value').then(function(snap){
      if (!snap.exists()) return;

      var order = snap.val() || {};
      if ((order.status || 'OK') === 'VOID') {
        showToast('æ­¤å–®å·²ä½œå»¢');
        return;
      }

      var items = order.items || [];
      var cm = {};
      for (var i=0;i<items.length;i++){
        if (!items[i].menuId) continue;
        cm[items[i].menuId] = (cm[items[i].menuId] || 0) + 1;
      }

      var promises = [];
      for (var mid in cm) if (cm.hasOwnProperty(mid)) promises.push(incStockTx(mid, cm[mid]));
      promises.push(ref.update({ status: 'VOID', voidedAt: new Date().toISOString() }));

      // ç§»é™¤ KDSï¼ˆæ–°å¯«æ³•æœƒç”¨ orderId åš keyï¼ŒèˆŠè³‡æ–™ä¸å½±éŸ¿ï¼‰
      if (order.orderId) {
        promises.push(db.ref('kdsByOrderId/' + order.orderId).remove().catch(function(){}));
      }

      return Promise.all(promises).then(function(){
        showToast('ä½œå»¢å®Œæˆï¼ˆå·²å›è£œåº«å­˜ï¼‰');
      });
    }).catch(function(err){
      showToast('ä½œå»¢å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
    });
  }

  /* -----------------------------
     Checkout (Cloud Print) + Watchdog
  ----------------------------- */
  function cleanupCheckout(btn, watchdogTimer) {
    if (watchdogTimer) clearTimeout(watchdogTimer);
    busyCheckout = false;
    btn.disabled = false;
    btn.classList.remove('opacity-60');
    sidebarToggle(false);
  }

  function processCheckout() {
    if (busyCheckout) return;
    if (cart.length === 0) return;

    // æœªé–‹ç­ç¦æ­¢çµå¸³
    if (!currentShiftId) {
      showToast('å°šæœªé–‹ç­ï¼Œè«‹å…ˆé–‹ç­å†çµå¸³');
      return;
    }

    busyCheckout = true;
    var btn = document.getElementById('checkoutBtn');
    btn.disabled = true;
    btn.classList.add('opacity-60');

    var watchdog = setTimeout(function(){
      busyCheckout = false;
      btn.disabled = false;
      btn.classList.remove('opacity-60');
      sidebarToggle(false);
      showToast('çµå¸³é€¾æ™‚ï¼Œå·²è§£é™¤é–å®šï¼ˆè«‹æª¢æŸ¥ç¶²è·¯/é›²ç«¯ï¼‰');
    }, 9000);

    // count map by menuId
    var countMap = {};
    for (var i = 0; i < cart.length; i++) {
      var id = cart[i].menuId;
      countMap[id] = (countMap[id] || 0) + 1;
    }
    var menuIds = [];
    for (var k in countMap) if (countMap.hasOwnProperty(k)) menuIds.push(k);

    var now = new Date();
    var oId = String(Date.now()); // ç”¨é•·å–®è™Ÿé™ä½ç¢°æ’
    var total = 0;
    for (var t = 0; t < cart.length; t++) total += Number(cart[t].price || 0);

    var qNo = null;
    var sid = currentShiftId;

    nextQueueNoTx(sid)
      .then(function(queueNo){
        qNo = queueNo;

        // serial stock deductions
        var chain = Promise.resolve(true);
        for (var i2 = 0; i2 < menuIds.length; i2++) {
          (function(mid){
            chain = chain.then(function(ok){
              if (!ok) return false;
              return decStockTx(mid, countMap[mid]);
            });
          })(menuIds[i2]);
        }
        return chain;
      })
      .then(function(ok){
        if (!ok) {
          showToast('åº«å­˜ä¸è¶³ï¼Œå·²å–æ¶ˆçµå¸³');
          throw new Error('STOCK_NOT_ENOUGH');
        }

        var oData = {
          date: now.toISOString(),
          total: total,
          queueNo: qNo,
          orderId: oId,
          shiftId: sid,
          status: 'OK',
          items: cart.slice(),
          itemSummary: summarizeItems(cart)
        };

        // sales: ç”¨ pushï¼ˆä¿ç•™æ­·å²ï¼‰
        return db.ref('sales').push(oData)
          .then(function(res){
            // KDSï¼šç”¨ orderId åš keyï¼ˆä½œå»¢/å®Œæˆæ›´å¥½è™•ç†ï¼‰
            return db.ref('kdsByOrderId/' + oId).set({
              queueNo: qNo,
              items: cart.slice(),
              time: now.toISOString(),
              orderId: oId
            });
          })
          .then(function(){
            var printHtml = ''
              + '<div class="print-page" style="text-align:center;">'
              +   '<h2 style="margin:0;">' + escapeHTML(settings.storeName) + '</h2>'
              +   '<h1 style="margin:2mm 0;">#' + escapeHTML(qNo) + '</h1>'
              +   '<div style="font-size:9pt;">' + escapeHTML(now.toLocaleString()) + '</div>'
              +   '<hr>'
              +   '<div style="width:100%; text-align:left;">';

            for (var i4 = 0; i4 < cart.length; i4++) {
              printHtml += ''
                + '<div style="display:flex; justify-content:space-between; margin-bottom:1mm;">'
                +   '<span style="font-weight:bold;">' + escapeHTML(cart[i4].name) + '</span>'
                +   '<span>$' + escapeHTML(cart[i4].price) + '</span>'
                + '</div>';
            }

            printHtml += ''
              +   '</div>'
              +   '<hr>'
              +   '<div style="display:flex; justify-content:space-between; font-size:16pt; font-weight:bold;">'
              +     '<span>ç¸½è¨ˆ</span>'
              +     '<span>$' + escapeHTML(total) + '</span>'
              +   '</div>'
              +   '<div style="font-size:9pt; margin-top:4mm;">'
              +     escapeHTML(settings.phone) + '<br>'
              +     escapeHTML(settings.note || '') + '<br>'
              +     '*** è¬è¬æƒ é¡§ ***'
              +   '</div>'
              + '</div>';

            return enqueuePrintJob({ type: 'receipt', html: printHtml, meta: { queueNo: qNo, orderId: oId, total: total, shiftId: sid } });
          });
      })
      .then(function(){
        cart = [];
        renderCartUI();
        showToast('çµå¸³å®Œæˆï¼å–å–®è™Ÿ #' + qNo + 'ï¼ˆåˆ—å°å·²é€å‡ºï¼‰');
        cleanupCheckout(btn, watchdog);
      })
      .catch(function(err){
        if (err && err.message === 'STOCK_NOT_ENOUGH') {
          // å·²æç¤º
        } else {
          showToast('çµå¸³å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
        }
        cleanupCheckout(btn, watchdog);
      });
  }

  /* -----------------------------
     Report filter handlers
  ----------------------------- */
  function applyReportFilterFromUI() {
    var sel = document.getElementById('shiftSelect');
    var dtS = document.getElementById('dtStart');
    var dtE = document.getElementById('dtEnd');

    reportFilter.shiftId = sel ? (sel.value || '') : '';

    var s = parseLocalInputValue(dtS ? dtS.value : '');
    var e = parseLocalInputValue(dtE ? dtE.value : '');
    reportFilter.start = s;
    reportFilter.end = e;

    renderReportUI();
    showToast('å ±è¡¨å·²å¥—ç”¨ç¯©é¸');
  }

  function resetReportFilterUI() {
    reportFilter.shiftId = '';
    reportFilter.start = null;
    reportFilter.end = null;

    var sel = document.getElementById('shiftSelect');
    if (sel) sel.value = currentShiftId || '';

    // é è¨­ï¼šå¦‚æœæœ‰ç­åˆ¥ï¼Œå°±ç”¨ç­åˆ¥é–‹å§‹åˆ°ç¾åœ¨ï¼›æ²’æœ‰å°±ä»Šå¤© 00:00 åˆ°ç¾åœ¨
    var now = new Date();
    var s = new Date();
    s.setHours(0,0,0,0);
    document.getElementById('dtStart').value = toLocalInputValue(s);
    document.getElementById('dtEnd').value = toLocalInputValue(now);

    reportFilter.start = s;
    reportFilter.end = now;
    reportFilter.shiftId = currentShiftId || '';

    renderReportUI();
    showToast('å ±è¡¨ç¯©é¸å·²é‡ç½®');
  }

  /* -----------------------------
     Init
  ----------------------------- */
  function init() {
    // tabs
    var tabBtns = document.querySelectorAll('header nav button[data-tab]');
    for (var i = 0; i < tabBtns.length; i++) {
      tabBtns[i].addEventListener('click', function(){ changeTab(this.getAttribute('data-tab')); });
    }

    // sidebar buttons
    document.getElementById('openSidebarBtn').addEventListener('click', function(){ sidebarToggle(true); });
    document.getElementById('closeSidebarBtn').addEventListener('click', function(){ sidebarToggle(false); });

    // actions
    document.getElementById('checkoutBtn').addEventListener('click', processCheckout);
    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
    document.getElementById('addProductBtn').addEventListener('click', addProduct);
    document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);

    // shift actions (3 places)
    document.getElementById('openShiftBtn').addEventListener('click', openShift);
    document.getElementById('closeShiftBtn').addEventListener('click', closeShift);
    document.getElementById('openShiftAdminBtn').addEventListener('click', openShift);
    document.getElementById('closeShiftAdminBtn').addEventListener('click', closeShift);
    document.getElementById('openShiftMiniBtn').addEventListener('click', openShift);
    document.getElementById('closeShiftMiniBtn').addEventListener('click', closeShift);

    // report filter buttons
    document.getElementById('applyReportFilterBtn').addEventListener('click', applyReportFilterFromUI);
    document.getElementById('resetReportFilterBtn').addEventListener('click', resetReportFilterUI);

    // settings sync
    db.ref('settings').on('value', function(snap){
      if (!snap.exists()) return;
      settings = snap.val() || settings;
      if (!settings.storeId) settings.storeId = 'default';
      if (!settings.storeName) settings.storeName = 'PRO POS';
      if (!settings.phone) settings.phone = '';
      if (!settings.note) settings.note = '';

      safeText(document.getElementById('displayStoreName'), settings.storeName);
      document.getElementById('cfgStoreId').value = settings.storeId || 'default';
      document.getElementById('cfgStoreName').value = settings.storeName || '';
      document.getElementById('cfgPhone').value = settings.phone || '';
      document.getElementById('cfgNote').value = settings.note || '';
    });

    // shift current id sync
    db.ref('runtime/currentShiftId').on('value', function(snap){
      currentShiftId = snap.val() || null;
      setShiftUI();
      listenShiftQueuePreview(currentShiftId);

      // report é è¨­ shift
      var sel = document.getElementById('shiftSelect');
      if (sel && currentShiftId) sel.value = currentShiftId;

      // æ²’ç¯©é¸æ™‚ï¼Œé è¨­å¡«æ™‚é–“
      // è‹¥ä½ å·²ç¶“æ‰‹å‹•æ”¹éï¼Œé‡ç½®æŒ‰éˆ•æ‰æœƒè¦†è“‹
      if (!document.getElementById('dtStart').value) {
        var now = new Date();
        var s = new Date(); s.setHours(0,0,0,0);
        document.getElementById('dtStart').value = toLocalInputValue(s);
        document.getElementById('dtEnd').value = toLocalInputValue(now);
        reportFilter.start = s;
        reportFilter.end = now;
      }
    });

    // shifts list sync (recent)
    db.ref('shifts').limitToLast(100).on('value', function(snap){
      shifts = snapToArrayWithKey(snap);
      renderShiftSelect();
    });

    // menu sync
    db.ref('menu').on('value', function(snap){
      var arr = snapToArrayWithKey(snap);
      var out = [];
      for (var i = 0; i < arr.length; i++) {
        var x = arr[i] || {};
        out.push({
          id: x.id || x.__key,
          name: x.name || '',
          price: Number(x.price || 0),
          stock: Number(x.stock || 0)
        });
      }
      out.sort(function(a,b){ return (a.name||'').localeCompare((b.name||''), 'zh-Hant'); });
      menu = out;
      renderMenu();
      renderAdminUI();
    });

    // sales sync
    db.ref('sales').on('value', function(snap){
      var arr = snapToArrayWithKey(snap);
      for (var i = 0; i < arr.length; i++) arr[i].total = Number(arr[i].total || 0);
      sales = arr;
      if (document.getElementById('reportTab').classList.contains('active')) renderReportUI();
    });

    // kds sync (æ–°çš„è·¯å¾‘)
    db.ref('kdsByOrderId').on('value', function(snap){
      var arr = snapToArrayWithKey(snap);
      arr.sort(function(a,b){ return new Date(a.time) - new Date(b.time); });
      kdsOrders = arr;
      renderKDSUI();
    });

    // clock/timers
    setInterval(function(){ document.getElementById('digitalClock').innerText = new Date().toLocaleTimeString(); }, 1000);
    setInterval(refreshKDSTimers, 1000);

    renderCartUI();
    setShiftUI();
  }

  init();
</script>

</body>
</html>
