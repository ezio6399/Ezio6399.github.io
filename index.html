<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>å—å±¯ä»»çƒ¤é­š - é›²ç«¯ç‰ˆ v17 (Universal Stable)</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: -apple-system, system-ui, sans-serif; touch-action: manipulation; -webkit-overflow-scrolling: touch; overflow: hidden; background-color: #f8fafc; }
    .tab-content { display: none; height: calc(100vh - 64px); width: 100%; }
    .tab-content.active { display: flex; }

    #sidebar { position: fixed; top: 0; right: 0; bottom: 0; width: 380px; background: white; z-index: 100; display: flex; flex-direction: column; border-left: 1px solid #e2e8f0; transition: transform 0.3s ease-in-out; box-shadow: -4px 0 15px rgba(0,0,0,0.05); }
    @media (min-width: 1024px) { #sidebar { position: relative; transform: translateX(0) !important; visibility: visible !important; } }
    @media (max-width: 1023px) { #sidebar { transform: translateX(100%); z-index: 200; } #sidebar.sidebar-active { transform: translateX(0); visibility: visible !important; } }

    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; color: black !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 52mm; margin: 0; padding: 0; }
      .print-page { width: 100%; font-family: monospace; font-size: 12pt; line-height: 1.2; page-break-after: always; padding: 2mm; }
      .print-page h1 { font-size: 24pt !important; font-weight: 900 !important; margin: 2mm 0; }
      .print-page h2 { font-size: 16pt !important; font-weight: bold !important; }
      hr { border: none; border-top: 1px dashed black !important; margin: 2mm 0; }
    }
  </style>
</head>

<body class="h-screen flex flex-col">

<header class="bg-slate-900 text-white h-16 flex items-center justify-between px-6 flex-shrink-0 z-[250] no-print">
  <div class="flex items-center space-x-6">
    <span id="displayStoreName" class="text-xl font-black bg-blue-600 px-3 py-1 rounded tracking-tighter">PRO POS</span>
    <nav class="flex space-x-2 font-bold text-sm">
      <button data-tab="orderTab" class="px-4 py-2 rounded-xl hover:bg-slate-800 transition">é»é¤</button>
      <button data-tab="kdsTab" class="px-4 py-2 rounded-xl hover:bg-slate-800 text-orange-400">å»šæˆ¿</button>
      <button data-tab="reportTab" class="px-4 py-2 rounded-xl hover:bg-slate-800 text-slate-400">å ±è¡¨</button>
      <button data-tab="adminTab" class="px-4 py-2 rounded-xl hover:bg-slate-800 text-slate-400">è¨­å®š</button>
    </nav>
  </div>
  <div id="digitalClock" class="font-mono text-slate-400 tracking-widest hidden md:block">00:00:00</div>
</header>

<main class="flex-1 flex overflow-hidden relative">
  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-[150] hidden"></div>

  <div id="orderTab" class="tab-content active w-full">
    <div class="flex-1 p-6 overflow-y-auto">
      <div id="menuDisplay" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-4"></div>
      <div class="h-32"></div>
    </div>

    <div id="sidebar">
      <div class="p-6 bg-slate-50 border-b flex justify-between items-center">
        <div class="flex flex-col">
          <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Queue No.</span>
          <span class="text-3xl font-black text-blue-600 italic">#<span id="nextQueueNo">001</span></span>
        </div>
        <button id="closeSidebarBtn" class="lg:hidden w-12 h-12 bg-white rounded-full shadow-sm border flex items-center justify-center font-bold text-slate-500 text-2xl">âœ•</button>
      </div>
      <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>
      <div class="p-6 bg-slate-50 border-t space-y-4 pb-12">
        <div class="flex justify-between items-center text-3xl font-black text-slate-800">
          <span class="text-base text-slate-400 uppercase font-bold tracking-wider">Total</span>
          <span>$<span id="totalPrice">0</span></span>
        </div>
        <button id="checkoutBtn" class="w-full bg-blue-600 text-white py-6 rounded-2xl text-2xl font-black shadow-lg shadow-blue-200 active:bg-blue-800 transition-all">ç¢ºèªçµå¸³</button>
      </div>
    </div>

    <button id="openSidebarBtn" class="lg:hidden fixed bottom-8 right-8 bg-blue-600 text-white w-20 h-20 rounded-full shadow-2xl flex items-center justify-center z-[120] active:scale-95 transition-transform">
      <span class="text-3xl">ğŸ›’</span>
      <span id="mobileCartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-sm w-8 h-8 rounded-full flex items-center justify-center border-4 border-white font-black">0</span>
    </button>
  </div>

  <div id="kdsTab" class="tab-content bg-slate-800 p-6 overflow-x-auto">
    <div id="kdsContainer" class="flex space-x-6 h-full items-start"></div>
  </div>

  <div id="reportTab" class="tab-content bg-slate-100 p-8 overflow-y-auto flex-col">
    <div class="max-w-5xl mx-auto w-full space-y-6">
      <div class="grid grid-cols-3 gap-6 font-black text-center">
        <div class="bg-white p-6 rounded-3xl border shadow-sm">
          <p class="text-xs text-slate-400 uppercase">ä»Šæ—¥ç‡Ÿæ”¶</p>
          <p id="totalRevenue" class="text-blue-600 text-2xl">$0</p>
        </div>
        <div class="bg-white p-6 rounded-3xl border shadow-sm">
          <p class="text-xs text-slate-400 uppercase">å–®æ•¸</p>
          <p id="totalOrders" class="text-2xl text-slate-800">0</p>
        </div>
        <button id="exportExcelBtn" class="bg-emerald-600 text-white rounded-3xl text-xl shadow-lg active:bg-emerald-700">åŒ¯å‡º Excel</button>
      </div>

      <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
        <table class="w-full text-left font-bold border-collapse">
          <thead class="bg-slate-50 border-b text-slate-400 text-xs uppercase">
            <tr class="divide-x">
              <th class="p-4">æ™‚é–“</th>
              <th class="p-4 text-center">å–å–®è™Ÿ</th>
              <th class="p-4 text-right">é‡‘é¡</th>
              <th class="p-4 text-center">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="reportTableBody" class="divide-y text-sm"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="adminTab" class="tab-content bg-white p-8 overflow-y-auto flex-col">
    <div class="max-w-xl mx-auto w-full space-y-10">
      <section class="bg-slate-50 p-6 rounded-3xl border space-y-4">
        <h2 class="text-2xl font-black text-blue-600 border-l-8 border-blue-600 pl-4">å“ç‰Œèˆ‡å°ç¥¨è¨­å®š</h2>
        <input type="text" id="cfgStoreName" placeholder="è‡ªå®šç¾©åº—å" class="w-full p-4 rounded-2xl border font-bold">
        <input type="text" id="cfgPhone" placeholder="æ”¶æ“šè¯çµ¡é›»è©±" class="w-full p-4 rounded-2xl border font-bold">
        <input type="text" id="cfgNote" placeholder="æ”¶æ“šåº•éƒ¨è¨Šæ¯ (å¦‚ï¼šè¬è¬æƒ é¡§)" class="w-full p-4 rounded-2xl border font-bold">
        <button id="saveSettingsBtn" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black active:scale-95 transition">å„²å­˜é›²ç«¯è¨­å®š</button>
      </section>

      <section class="bg-slate-50 p-6 rounded-3xl border space-y-4">
        <h2 class="text-2xl font-black text-green-600 border-l-8 border-green-600 pl-4">é¤é»åº«å­˜ç®¡ç†</h2>
        <div class="flex flex-col sm:flex-row gap-2">
          <input type="text" id="newProdName" placeholder="é¤é»å“å" class="flex-1 p-3 border rounded-xl font-bold">
          <input type="number" id="newProdPrice" placeholder="åƒ¹æ ¼" class="w-full sm:w-24 p-3 border rounded-xl font-bold text-center">
          <input type="number" id="newProdStock" placeholder="åº«å­˜" class="w-full sm:w-24 p-3 border rounded-xl font-bold text-center">
        </div>
        <button id="addProductBtn" class="w-full bg-blue-600 text-white py-3 rounded-2xl font-black active:scale-95 transition">æ–°å¢ç”¢å“</button>
        <div id="menuListUI" class="space-y-2 mt-4"></div>
      </section>
    </div>
  </div>
</main>

<div id="printArea"></div>

<script>
  /* Firebase åˆå§‹åŒ– */
  var firebaseConfig = {
    apiKey: "AIzaSyB4V2Zfzl_22tka2QHfkNSGaa23ke2TeWk",
    authDomain: "flash-e1c46.firebaseapp.com",
    projectId: "flash-e1c46",
    storageBucket: "flash-e1c46.firebasestorage.app",
    messagingSenderId: "927841326710",
    appId: "1:927841326710:web:d832accdbf2a323ad1b157",
    measurementId: "G-BVT622JRJT",
    databaseURL: "https://flash-e1c46-default-rtdb.firebaseio.com/"
  };

  firebase.initializeApp(firebaseConfig);
  var db = firebase.database();

  /* ç³»çµ±ç‹€æ…‹ */
  var settings = { storeName: 'å—å±¯ä»»çƒ¤é­š', phone: '02-1234', note: 'è¬è¬æƒ é¡§' };
  var menu = [];      // [{id,name,price,stock}]
  var sales = [];     // [{... , __key}]
  var kdsOrders = []; // [{... , __key}]
  var cart = [];      // [{menuId,name,price}]
  var busyCheckout = false;

  /* Utility */
  function todayKeyISO() {
    return new Date().toISOString().split('T')[0];
  }
  function fmtMoney(n) {
    n = Number(n || 0);
    return n.toLocaleString();
  }
  function safeText(el, text) {
    el.textContent = String(text !== undefined && text !== null ? text : '');
  }
  function escapeHTML(str) {
    str = String(str !== undefined && str !== null ? str : '');
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function sidebarToggle(open) {
    var sb = document.getElementById('sidebar');
    var ov = document.getElementById('sidebarOverlay');
    if (open) {
      sb.classList.add('sidebar-active');
      ov.classList.remove('hidden');
    } else {
      sb.classList.remove('sidebar-active');
      ov.classList.add('hidden');
    }
  }

  function changeTab(id) {
    var tabs = document.querySelectorAll('.tab-content');
    for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
    document.getElementById(id).classList.add('active');
    if (id === 'reportTab') renderReportUI();
    sidebarToggle(false);
  }

  function snapToArrayWithKey(snap) {
    var out = [];
    snap.forEach(function(child) {
      var v = child.val() || {};
      v.__key = child.key;
      out.push(v);
    });
    return out;
  }

  /* Transactions */
  function nextQueueNoTx(dateKey) {
    var ref = db.ref('dailyCounters/' + dateKey + '/queue');
    return ref.transaction(function(cur) {
      return (cur || 0) + 1;
    }).then(function(res) {
      if (!res.committed) throw new Error('Queue transaction failed');
      return String(res.snapshot.val()).padStart(3, '0');
    });
  }

  function decStockTx(menuId, qty) {
    qty = qty || 1;
    var ref = db.ref('menu/' + menuId + '/stock');
    return ref.transaction(function(cur) {
      if (cur === null) return;         // cancel
      if (cur < qty) return;            // cancel
      return cur - qty;
    }).then(function(res) {
      return !!res.committed;
    });
  }

  function incStockTx(menuId, qty) {
    qty = qty || 1;
    var ref = db.ref('menu/' + menuId + '/stock');
    return ref.transaction(function(cur) {
      if (cur === null) return (0 + qty);
      return cur + qty;
    }).then(function(res) {
      return !!res.committed;
    });
  }

  /* UI render */
  function renderMenu() {
    var wrap = document.getElementById('menuDisplay');
    var html = '';
    for (var i = 0; i < menu.length; i++) {
      var p = menu[i];
      var disabled = (Number(p.stock) <= 0);
      html += ''
        + '<div class="' + (disabled ? 'bg-slate-200 opacity-60 cursor-not-allowed' : 'bg-white active:bg-blue-50 cursor-pointer')
        + ' p-6 rounded-[2rem] border shadow-sm h-40 flex flex-col justify-between relative active:scale-95 transition-all"'
        + ' data-id="' + escapeHTML(p.id) + '">'
        +   '<span class="name font-black text-slate-800 text-xl leading-tight"></span>'
        +   '<div class="flex justify-between items-end">'
        +     '<span class="text-blue-600 font-black text-2xl">$' + escapeHTML(p.price) + '</span>'
        +     '<span class="text-xs font-bold text-slate-400">STOCK: ' + escapeHTML(p.stock) + '</span>'
        +   '</div>'
        +   (disabled ? '<span class="absolute inset-0 flex items-center justify-center font-black text-red-500 rotate-12 text-2xl">SOLD OUT</span>' : '')
        + '</div>';
    }
    wrap.innerHTML = html;

    var cards = wrap.children;
    for (var j = 0; j < cards.length; j++) {
      (function(idx) {
        var card = cards[idx];
        var p2 = menu[idx];
        card.querySelector('.name').textContent = p2.name;
        if (Number(p2.stock) > 0) {
          card.addEventListener('click', function() { addItemToCart(p2.id); });
        }
      })(j);
    }
  }

  function addItemToCart(menuId) {
    var m = null;
    for (var i = 0; i < menu.length; i++) {
      if (menu[i].id === menuId) { m = menu[i]; break; }
    }
    if (!m || Number(m.stock) <= 0) return;

    cart.push({ menuId: m.id, name: m.name, price: Number(m.price) });
    renderCartUI();
    if (window.innerWidth < 1024) sidebarToggle(true);
  }

  function renderCartUI() {
    document.getElementById('mobileCartCount').innerText = String(cart.length);
    var container = document.getElementById('cartItems');

    if (cart.length === 0) {
      container.innerHTML = '<div class="h-full flex items-center justify-center text-slate-300 italic py-20">ç­‰å¾…é»é¤...</div>';
      document.getElementById('totalPrice').innerText = '0';
      return;
    }

    var html = '';
    for (var i = 0; i < cart.length; i++) {
      html += ''
        + '<div class="flex justify-between items-center bg-slate-50 p-5 rounded-2xl border text-lg font-bold">'
        +   '<span class="item-name"></span>'
        +   '<div class="flex items-center space-x-4">'
        +     '<span>$' + escapeHTML(cart[i].price) + '</span>'
        +     '<button class="remove-btn w-10 h-10 bg-white text-red-500 rounded-full shadow-sm flex items-center justify-center text-xl font-black" data-idx="' + i + '">âœ•</button>'
        +   '</div>'
        + '</div>';
    }
    container.innerHTML = html;

    var rows = container.children;
    for (var r = 0; r < rows.length; r++) {
      rows[r].querySelector('.item-name').textContent = cart[r].name;
    }

    var btns = container.querySelectorAll('.remove-btn');
    for (var b = 0; b < btns.length; b++) {
      btns[b].addEventListener('click', function(e) {
        e.stopPropagation();
        var idx = Number(this.getAttribute('data-idx'));
        cart.splice(idx, 1);
        renderCartUI();
      });
    }

    var total = 0;
    for (var t = 0; t < cart.length; t++) total += Number(cart[t].price || 0);
    document.getElementById('totalPrice').innerText = fmtMoney(total);
  }

  function renderKDSUI() {
    var wrap = document.getElementById('kdsContainer');
    var html = '';

    for (var i = 0; i < kdsOrders.length; i++) {
      var o = kdsOrders[i];
      var itemsHtml = '';
      if (o.items && o.items.length) {
        for (var k = 0; k < o.items.length; k++) {
          itemsHtml += '<div class="border-b pb-2">â–¡ ' + escapeHTML(o.items[k].name) + '</div>';
        }
      }
      html += ''
        + '<div class="w-80 bg-white rounded-[2.5rem] shadow-2xl flex-shrink-0 flex flex-col border-4 border-blue-500 overflow-hidden h-fit">'
        +   '<div class="bg-blue-600 text-white p-5 flex justify-between items-center">'
        +     '<span class="text-4xl font-black">#' + escapeHTML(o.queueNo) + '</span>'
        +     '<span class="font-mono text-xl timer" data-start="' + escapeHTML(o.time) + '">00:00</span>'
        +   '</div>'
        +   '<div class="p-6 space-y-3 font-black text-2xl text-slate-700">' + itemsHtml + '</div>'
        +   '<button class="done-btn bg-emerald-500 text-white py-8 text-3xl font-black active:bg-emerald-700 transition" data-kdskey="' + escapeHTML(o.__key) + '">å®Œæˆ</button>'
        + '</div>';
    }

    wrap.innerHTML = html;

    var doneBtns = wrap.querySelectorAll('.done-btn');
    for (var j = 0; j < doneBtns.length; j++) {
      doneBtns[j].addEventListener('click', function() {
        var key = this.getAttribute('data-kdskey');
        if (!key) return;
        db.ref('kds').child(key).remove();
      });
    }
  }

  function renderReportUI() {
    var today = todayKeyISO();
    var filtered = [];

    for (var i = 0; i < sales.length; i++) {
      var d = (sales[i].date || '').split('T')[0];
      if (d === today) filtered.push(sales[i]);
    }

    filtered.sort(function(a, b) {
      return new Date(b.date) - new Date(a.date);
    });

    var revenue = 0;
    for (var r = 0; r < filtered.length; r++) revenue += Number(filtered[r].total || 0);

    document.getElementById('totalRevenue').innerText = '$' + fmtMoney(revenue);
    document.getElementById('totalOrders').innerText = String(filtered.length);

    var body = document.getElementById('reportTableBody');
    var html = '';
    for (var j = 0; j < filtered.length; j++) {
      var s = filtered[j];
      var time = new Date(s.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      html += ''
        + '<tr>'
        +   '<td class="p-6 text-blue-600 font-black">' + escapeHTML(time) + '</td>'
        +   '<td class="p-6 text-center text-2xl font-black">#' + escapeHTML(s.queueNo) + '</td>'
        +   '<td class="p-6 text-right font-black text-2xl">$' + fmtMoney(s.total) + '</td>'
        +   '<td class="p-6 text-center"><button class="void-btn text-red-500 font-black border-2 border-red-50 px-4 py-1 rounded-xl active:bg-red-50 transition" data-orderid="' + escapeHTML(s.orderId) + '">ä½œå»¢</button></td>'
        + '</tr>';
    }
    body.innerHTML = html;

    var voidBtns = body.querySelectorAll('.void-btn');
    for (var vb = 0; vb < voidBtns.length; vb++) {
      voidBtns[vb].addEventListener('click', function() {
        voidOrder(this.getAttribute('data-orderid'));
      });
    }
  }

  function refreshKDSTimers() {
    var els = document.querySelectorAll('.timer');
    for (var i = 0; i < els.length; i++) {
      var start = new Date(els[i].getAttribute('data-start'));
      if (isNaN(start.getTime())) continue;
      var diff = Math.floor((new Date() - start) / 1000);
      var m = Math.floor(diff / 60);
      var s = diff % 60;
      var mm = String(m).padStart(2, '0');
      var ss = String(s).padStart(2, '0');
      els[i].textContent = mm + ':' + ss;
    }
  }

  function updateQueueDisplayFromCounter(counterVal) {
    var next = Number(counterVal || 0) + 1;
    document.getElementById('nextQueueNo').innerText = String(next).padStart(3, '0');
  }

  /* çµå¸³ï¼ˆPromise chain ç‰ˆæœ¬ï¼Œè·¨è£ç½®ç©©ï¼‰ */
  function processCheckout() {
    if (busyCheckout) return;
    if (cart.length === 0) return;

    busyCheckout = true;
    var checkoutBtn = document.getElementById('checkoutBtn');
    checkoutBtn.disabled = true;
    checkoutBtn.classList.add('opacity-60');

    var dateKey = todayKeyISO();

    // çµ±è¨ˆæ¯å€‹ menuId çš„æ•¸é‡ï¼ˆä¸ç”¨ Object.entriesï¼‰
    var countMap = {}; // {menuId: qty}
    for (var i = 0; i < cart.length; i++) {
      var id = cart[i].menuId;
      countMap[id] = (countMap[id] || 0) + 1;
    }

    var menuIds = [];
    for (var k in countMap) if (countMap.hasOwnProperty(k)) menuIds.push(k);

    var qNo = null;

    nextQueueNoTx(dateKey)
      .then(function(queueNo) {
        qNo = queueNo;

        // é€é …æ‰£åº«å­˜ï¼ˆä¸²è¡Œï¼Œç©©ä½†æ…¢ä¸€é»ï¼Œåæ­£ POS ä¸éœ€è¦æ¯ç§’ 1000 å–®ï¼‰
        var chain = Promise.resolve(true);
        for (var i2 = 0; i2 < menuIds.length; i2++) {
          (function(mid) {
            chain = chain.then(function(ok) {
              if (!ok) return false;
              return decStockTx(mid, countMap[mid]);
            });
          })(menuIds[i2]);
        }
        return chain;
      })
      .then(function(ok) {
        if (!ok) {
          alert('åº«å­˜ä¸è¶³æˆ–å•†å“ä¸å­˜åœ¨ï¼Œå·²å–æ¶ˆæœ¬æ¬¡çµå¸³ã€‚');
          throw new Error('STOCK_NOT_ENOUGH');
        }

        var now = new Date();
        var oId = String(Date.now()).slice(-6);
        var total = 0;
        for (var i3 = 0; i3 < cart.length; i3++) total += Number(cart[i3].price || 0);

        var oData = {
          date: now.toISOString(),
          total: total,
          queueNo: qNo,
          orderId: oId,
          items: cart.slice()
        };

        // sales / kds ç”¨ pushï¼ˆé¿å… key äº‚æ‰ï¼‰
        return db.ref('sales').push(oData).then(function() {
          return db.ref('kds').push({ queueNo: qNo, items: cart.slice(), time: now.toISOString(), orderId: oId });
        }).then(function() {
          // print
          var printHtml = ''
            + '<div class="print-page" style="text-align:center;">'
            +   '<h2 style="margin:0;">' + escapeHTML(settings.storeName) + '</h2>'
            +   '<h1 style="margin:2mm 0;">#' + escapeHTML(qNo) + '</h1>'
            +   '<div style="font-size:9pt;">' + escapeHTML(now.toLocaleString()) + '</div>'
            +   '<hr>'
            +   '<div style="width:100%; text-align:left;">';

          for (var i4 = 0; i4 < cart.length; i4++) {
            printHtml += ''
              + '<div style="display:flex; justify-content:space-between; margin-bottom:1mm;">'
              +   '<span style="font-weight:bold;">' + escapeHTML(cart[i4].name) + '</span>'
              +   '<span>$' + escapeHTML(cart[i4].price) + '</span>'
              + '</div>';
          }

          printHtml += ''
            +   '</div>'
            +   '<hr>'
            +   '<div style="display:flex; justify-content:space-between; font-size:16pt; font-weight:bold;">'
            +     '<span>ç¸½è¨ˆ</span>'
            +     '<span>$' + escapeHTML(total) + '</span>'
            +   '</div>'
            +   '<div style="font-size:9pt; margin-top:4mm;">'
            +     escapeHTML(settings.phone) + '<br>'
            +     escapeHTML(settings.note || '') + '<br>'
            +     '*** è¬è¬æƒ é¡§ ***'
            +   '</div>'
            + '</div>';

          document.getElementById('printArea').innerHTML = printHtml;
          window.print();

          // clear cart
          cart = [];
          renderCartUI();
          sidebarToggle(false);
          alert('çµå¸³å®Œæˆï¼å–å–®è™Ÿç‚ºï¼š' + qNo);
        });
      })
      .catch(function(err) {
        if (err && err.message === 'STOCK_NOT_ENOUGH') {
          // already alerted
        } else {
          console.error(err);
          alert('çµå¸³å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
        }
      })
      .finally(function() {
        busyCheckout = false;
        checkoutBtn.disabled = false;
        checkoutBtn.classList.remove('opacity-60');
      });
  }

  /* ä½œå»¢ï¼šå›è£œåº«å­˜ + åˆª sales */
  function voidOrder(oId) {
    if (!oId) return;
    if (!confirm('ç¢ºèªä½œå»¢æ­¤è¨‚å–®ï¼Ÿåº«å­˜å°‡å›è£œé›²ç«¯ã€‚')) return;

    db.ref('sales').orderByChild('orderId').equalTo(oId).once('value')
      .then(function(snap) {
        if (!snap.exists()) return;

        var promises = [];
        snap.forEach(function(child) {
          var order = child.val() || {};
          var items = order.items || [];

          // çµ±è¨ˆå›è£œ
          var cm = {};
          for (var i = 0; i < items.length; i++) {
            if (!items[i].menuId) continue;
            cm[items[i].menuId] = (cm[items[i].menuId] || 0) + 1;
          }

          for (var mid in cm) {
            if (cm.hasOwnProperty(mid)) promises.push(incStockTx(mid, cm[mid]));
          }

          promises.push(child.ref.remove());
        });

        return Promise.all(promises);
      })
      .catch(function(err) {
        console.error(err);
        alert('ä½œå»¢å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
      });
  }

  /* Admin */
  function saveSettings() {
    var storeName = (document.getElementById('cfgStoreName').value || '').trim() || 'PRO POS';
    var phone = (document.getElementById('cfgPhone').value || '').trim();
    var note = (document.getElementById('cfgNote').value || '').trim();

    db.ref('settings').set({ storeName: storeName, phone: phone, note: note })
      .then(function() { alert('é›²ç«¯å“ç‰Œè³‡è¨Šå·²åŒæ­¥'); })
      .catch(function(err) { alert('å„²å­˜å¤±æ•—ï¼š' + (err && err.message ? err.message : err)); });
  }

  function addProduct() {
    var name = (document.getElementById('newProdName').value || '').trim();
    var price = Number(document.getElementById('newProdPrice').value);
    var stock = Number(document.getElementById('newProdStock').value);
    if (!isFinite(stock)) stock = 0;

    if (!name || !isFinite(price) || price <= 0) return;

    var ref = db.ref('menu').push();
    ref.set({ id: ref.key, name: name, price: price, stock: stock })
      .then(function() {
        document.getElementById('newProdName').value = '';
        document.getElementById('newProdPrice').value = '';
        document.getElementById('newProdStock').value = '';
      })
      .catch(function(err) {
        alert('æ–°å¢å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
      });
  }

  function renderAdminUI() {
    var wrap = document.getElementById('menuListUI');
    var html = '';

    for (var i = 0; i < menu.length; i++) {
      var p = menu[i];
      html += ''
        + '<div class="flex justify-between items-center bg-white p-6 rounded-3xl border shadow-sm">'
        +   '<div class="flex flex-col">'
        +     '<span class="name font-black text-slate-700 text-xl font-sans"></span>'
        +     '<span class="text-blue-600 font-black">$' + escapeHTML(p.price) + '</span>'
        +   '</div>'
        +   '<div class="flex items-center space-x-4">'
        +     '<input type="number" value="' + escapeHTML(p.stock) + '" class="stock-input w-20 p-2 border-2 rounded-xl text-center font-black text-xl" data-id="' + escapeHTML(p.id) + '">'
        +     '<button class="delete-btn text-red-500 font-black px-4 text-2xl" data-id="' + escapeHTML(p.id) + '">âœ•</button>'
        +   '</div>'
        + '</div>';
    }

    wrap.innerHTML = html;

    var rows = wrap.children;
    for (var r = 0; r < rows.length; r++) {
      rows[r].querySelector('.name').textContent = menu[r].name;
    }

    var stockInputs = wrap.querySelectorAll('.stock-input');
    for (var s = 0; s < stockInputs.length; s++) {
      stockInputs[s].addEventListener('change', function() {
        var id = this.getAttribute('data-id');
        var val = Number(this.value);
        if (!id || !isFinite(val) || val < 0) return;
        db.ref('menu').child(id).update({ stock: Math.floor(val) });
      });
    }

    var delBtns = wrap.querySelectorAll('.delete-btn');
    for (var d = 0; d < delBtns.length; d++) {
      delBtns[d].addEventListener('click', function() {
        var id = this.getAttribute('data-id');
        if (!id) return;
        if (!confirm('åˆªé™¤ï¼Ÿ')) return;
        db.ref('menu').child(id).remove();
      });
    }
  }

  function exportToExcel() {
    var rows = [];
    for (var i = 0; i < sales.length; i++) {
      var s = sales[i];
      var itemsText = '';
      if (s.items && s.items.length) {
        var names = [];
        for (var k = 0; k < s.items.length; k++) names.push(s.items[k].name);
        itemsText = names.join(',');
      }
      rows.push({ 'æ™‚é–“': s.date, 'å–®è™Ÿ': s.orderId, 'å–å–®è™Ÿ': s.queueNo, 'ç¸½é¡': s.total, 'å…§å®¹': itemsText });
    }

    var ws = XLSX.utils.json_to_sheet(rows);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sales");
    XLSX.writeFile(wb, (settings.storeName || 'POS') + "_å ±è¡¨.xlsx");
  }

  /* Init */
  function init() {
    // tab buttons
    var tabBtns = document.querySelectorAll('header nav button[data-tab]');
    for (var i = 0; i < tabBtns.length; i++) {
      tabBtns[i].addEventListener('click', function() { changeTab(this.getAttribute('data-tab')); });
    }

    // sidebar
    document.getElementById('sidebarOverlay').addEventListener('click', function() { sidebarToggle(false); });
    document.getElementById('openSidebarBtn').addEventListener('click', function() { sidebarToggle(true); });
    document.getElementById('closeSidebarBtn').addEventListener('click', function() { sidebarToggle(false); });

    // main actions
    document.getElementById('checkoutBtn').addEventListener('click', processCheckout);
    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
    document.getElementById('addProductBtn').addEventListener('click', addProduct);
    document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);

    // settings sync
    db.ref('settings').on('value', function(snap) {
      if (!snap.exists()) return;
      settings = snap.val() || settings;
      safeText(document.getElementById('displayStoreName'), settings.storeName || 'PRO POS');
      document.getElementById('cfgStoreName').value = settings.storeName || '';
      document.getElementById('cfgPhone').value = settings.phone || '';
      document.getElementById('cfgNote').value = settings.note || '';
    });

    // menu sync
    db.ref('menu').on('value', function(snap) {
      var arr = snapToArrayWithKey(snap);
      var out = [];
      for (var i = 0; i < arr.length; i++) {
        var x = arr[i] || {};
        out.push({
          id: x.id || x.__key,
          name: x.name || '',
          price: Number(x.price || 0),
          stock: Number(x.stock || 0)
        });
      }
      // sort by name
      out.sort(function(a, b) { return (a.name || '').localeCompare((b.name || ''), 'zh-Hant'); });
      menu = out;
      renderMenu();
      renderAdminUI();
    });

    // sales sync
    db.ref('sales').on('value', function(snap) {
      var arr = snapToArrayWithKey(snap);
      for (var i = 0; i < arr.length; i++) arr[i].total = Number(arr[i].total || 0);
      sales = arr;
      renderReportUI();
    });

    // kds sync
    db.ref('kds').on('value', function(snap) {
      var arr = snapToArrayWithKey(snap);
      arr.sort(function(a, b) { return new Date(a.time) - new Date(b.time); });
      kdsOrders = arr;
      renderKDSUI();
    });

    // queue preview (display only)
    var dateKey = todayKeyISO();
    db.ref('dailyCounters/' + dateKey + '/queue').on('value', function(snap) {
      updateQueueDisplayFromCounter(snap.val() || 0);
    });

    // clock / timers
    setInterval(function() {
      document.getElementById('digitalClock').innerText = new Date().toLocaleTimeString();
    }, 1000);

    setInterval(refreshKDSTimers, 1000);

    renderCartUI();
  }

  init();
</script>
</body>
</html>
