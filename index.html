<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PRO POS - Cloud Print Agent</title>

  <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3.38.1/minified.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding: 16px; background:#0b1220; color:#e5e7eb; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card { background:#111827; border:1px solid #1f2937; padding:14px; border-radius:14px; }
    .log { margin-top:12px; border:1px solid #1f2937; padding:12px; border-radius:12px; height: 60vh; overflow:auto; background:#0f172a; }
    .badge { padding:4px 10px; border-radius:999px; color:#fff; font-size:12px; font-weight:900; }
    .ok { background:#16a34a; } .warn { background:#f59e0b; } .err { background:#dc2626; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; cursor:pointer; font-weight:900; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    input { padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; font-weight:800; }
    iframe { display:none; }
    .hint { color:#94a3b8; font-size:12px; font-weight:700; }
  </style>
</head>

<body>
  <div class="card">
    <h2 style="margin:0 0 8px 0;">雲端列印代理（Print Agent）</h2>
    <div class="row">
      <span class="badge warn" id="status">待命</span>
      <label style="font-weight:800;">Store ID：</label>
      <input id="storeId" value="default" />
      <button id="startBtn">開始監聽</button>
      <button id="stopBtn" disabled>停止</button>
      <button id="testBtn">送出測試任務</button>
    </div>
    <div class="hint" style="margin-top:8px;">
      這頁請在「接了熱感印表機」的 PC 上開著。請先設定預設印表機與紙張（57/58mm）。
    </div>
  </div>

  <div class="log" id="log"></div>
  <iframe id="printFrame"></iframe>

<script>
  var firebaseConfig = {
    apiKey: "AIzaSyB4V2Zfzl_22tka2QHfkNSGaa23ke2TeWk",
    authDomain: "flash-e1c46.firebaseapp.com",
    projectId: "flash-e1c46",
    storageBucket: "flash-e1c46.firebasestorage.app",
    messagingSenderId: "927841326710",
    appId: "1:927841326710:web:d832accdbf2a323ad1b157",
    measurementId: "G-BVT622JRJT",
    databaseURL: "https://flash-e1c46-default-rtdb.firebaseio.com/"
  };

  firebase.initializeApp(firebaseConfig);
  var db = firebase.database();

  var listeningRef = null;
  var isPrinting = false;

  function log(msg) {
    var el = document.getElementById('log');
    var line = document.createElement('div');
    line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
    el.appendChild(line);
    el.scrollTop = el.scrollHeight;
  }

  function setStatus(text, cls) {
    var s = document.getElementById('status');
    s.textContent = text;
    s.className = 'badge ' + cls;
  }

  function printHTML(html) {
    return new Promise(function(resolve, reject) {
      try {
        var iframe = document.getElementById('printFrame');
        var doc = iframe.contentWindow.document;
        doc.open();
        doc.write(
          '<!doctype html><html><head><meta charset="utf-8">' +
          '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
          '<style>@media print{body{margin:0;padding:0;} .print-page{width:52mm;font-family:monospace;font-size:12pt;line-height:1.2;padding:2mm;} h1{font-size:24pt;margin:2mm 0;font-weight:900;} h2{font-size:16pt;margin:0;font-weight:bold;} hr{border:none;border-top:1px dashed #000;margin:2mm 0;}}</style>' +
          '</head><body>' + (html || '') + '</body></html>'
        );
        doc.close();

        setTimeout(function() {
          try {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
            resolve(true);
          } catch (e2) { reject(e2); }
        }, 150);
      } catch (e) { reject(e); }
    });
  }

  function processJob(jobKey, jobVal, storeId) {
    if (isPrinting) return;
    if (!jobVal || jobVal.status !== 'NEW') return;

    isPrinting = true;
    setStatus('列印中', 'warn');
    log('收到任務：' + jobKey + ' type=' + jobVal.type);

    var jobRef = db.ref('printJobs/' + storeId + '/' + jobKey);

    jobRef.update({ status: 'PRINTING', printingAt: new Date().toISOString() })
      .then(function(){ return printHTML(jobVal.html || ''); })
      .then(function(){
        log('列印完成：' + jobKey);
        return jobRef.update({ status: 'DONE', doneAt: new Date().toISOString() });
      })
      .then(function(){
        isPrinting = false;
        setStatus('監聽中', 'ok');
      })
      .catch(function(err){
        log('列印失敗：' + jobKey + ' err=' + (err && err.message ? err.message : err));
        jobRef.update({ status: 'ERROR', errorAt: new Date().toISOString(), errorMsg: String(err && err.message ? err.message : err) })
          .then(function(){ isPrinting = false; setStatus('監聽中', 'ok'); });
      });
  }

  function startListening() {
    var storeId = (document.getElementById('storeId').value || 'default').trim() || 'default';
    if (listeningRef) listeningRef.off();

    listeningRef = db.ref('printJobs/' + storeId);
    setStatus('監聽中', 'ok');
    log('開始監聽：printJobs/' + storeId);

    listeningRef.on('child_added', function(snap){ processJob(snap.key, snap.val(), storeId); });
    listeningRef.on('child_changed', function(snap){ processJob(snap.key, snap.val(), storeId); });

    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
  }

  function stopListening() {
    if (listeningRef) listeningRef.off();
    listeningRef = null;
    setStatus('已停止', 'err');
    log('停止監聽');
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
  }

  function sendTestJob() {
    var storeId = (document.getElementById('storeId').value || 'default').trim() || 'default';
    var html = ''
      + '<div class="print-page" style="text-align:center;">'
      + '<h2 style="margin:0;">測試列印</h2>'
      + '<h1 style="margin:2mm 0;">#TEST</h1>'
      + '<div style="font-size:9pt;">' + new Date().toLocaleString() + '</div>'
      + '<hr><div style="text-align:left;">'
      + '<div style="display:flex;justify-content:space-between;"><span>測試品項</span><span>$10</span></div>'
      + '</div><hr>'
      + '<div style="display:flex; justify-content:space-between; font-size:16pt; font-weight:bold;"><span>總計</span><span>$10</span></div>'
      + '</div>';

    db.ref('printJobs/' + storeId).push({
      status: 'NEW',
      createdAt: new Date().toISOString(),
      type: 'test',
      html: html,
      meta: { test: true }
    }).then(function(){ log('已送出測試任務'); });
  }

  document.getElementById('startBtn').addEventListener('click', startListening);
  document.getElementById('stopBtn').addEventListener('click', stopListening);
  document.getElementById('testBtn').addEventListener('click', sendTestJob);

  log('提醒：POS 設定頁的 Store ID 必須跟這裡一致。');
</script>
</body>
</html>
